generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  role      String
  createdAt DateTime @default(now())
  lastLogin DateTime @default(now())
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String   @default("No description provided")
  tasks       Task[]   @relation("ProjectTasks")
  
}

model Task {
  id              Int                 @id @default(autoincrement())
  title           String
  description     String?
  createdAt       DateTime            @default(now())
  dueDate         DateTime?           @default(now())
  members         String[]
  projectId       Int
  updatedAt       DateTime            @updatedAt
  status          String              @default("Pending")
  owner           String
  project         String
  url             String?
  dependentTaskId Int[]               @default([])
  messages        Message?
  notes           Notes?
  projectRel      Project             @relation("ProjectTasks", fields: [projectId], references: [id])
  histories       TaskChangeHistory[]
  uploadedFiles   UploadedFile[]
}

model Message {
  id           Int      @id @default(autoincrement())
  taskId       Int      @unique
  conversation Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model Notes {
  id        Int      @id @default(autoincrement())
  taskId    Int      @unique // one-to-one: one Notes per Task
  notes     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("notes")
}


model UploadedFile {
  id           Int      @id @default(autoincrement())
  originalName String
  fileName     String
  filePath     String
  mimeType     String
  size         Int
  taskId       Int?
  messageId    String?
  uploadDate   DateTime @default(now())
  task         Task?    @relation(fields: [taskId], references: [id])

  @@map("uploaded_files")
}

model TaskChangeHistory {
  id            Int      @id @default(autoincrement())
  taskId        Int
  fieldChanged  String
  oldValue      String?
  newValue      String?
  changedAt     DateTime @default(now())
  changeGroupId String   @default(uuid())
  task          Task     @relation(fields: [taskId], references: [id])
}

model DeveloperPerformanceMetric {
  id                 Int        @id @default(autoincrement())
  developerId        String
  periodType         PeriodType
  startDate          DateTime
  endDate            DateTime
  cycleEfficiency    Float?
  totalLeadHours     Float?
  totalActiveHours   Float?
  completedTaskCount Int?
  deliveryRatePerDay Float?
  completedCount     Int?
  reworkRatio        Float?
  totalReopened      Int?
  computedAt         DateTime   @default(now())
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@unique([developerId, periodType, startDate, endDate])
}

model AutoMessageTemplate {
  id      Int     @id @default(autoincrement())
  from    String?
  to      String?
  type    String
  content String
}

enum PeriodType {
  daily
  weekly
  monthly
}
